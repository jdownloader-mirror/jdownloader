/*
 JDownloader API Bindings for jQuery (jQuery.jd)
 @version 07/2011
 @author mhils

 Callback functions accept the parameters data and pid (optional).

*/
(function(a){a.jd={setOptions:function(b){b&&a.extend(a.jd._settings,b);a.jd._settings.apiServer.match(/\/$/)||(a.jd._settings.apiServer+="/");return this},getOptions:function(){return a.extend(!0,{},a.jd._settings)},startSession:function(b,c,d){a.jd._ajax.sessionStatus!==a.jd.e.sessionStatus.NO_SESSION?a.jd.stopSession(function(){a.jd.startSession(b,c,d)}):(a.isFunction(b)&&(d=b,b=c=void 0),a.jd._settings.user=b?b:a.jd._settings.user,a.jd._settings.pass=c?c:a.jd._settings.pass,a.jd.send("session/handshake",
a.jd._settings.user?[a.jd._settings.user,a.jd._settings.pass]:["",""],function(e){a.jd._settings.debug&&console.log(["Handshake response:",e]);if(e&&typeof e==="string"&&e!==""&&e!==a.jd.e.sessionStatus.ERROR){var f=a.jd._settings.user?a.jd.e.sessionStatus.REGISTERED:a.jd.e.sessionStatus.ANONYMOUS;a.jd._ajax.token=e;a.jd._settings.user=b;a.jd._settings.pass=c;a.jd._ajax.sessionStatus=f;a.isFunction(d)&&d({status:a.jd._ajax.sessionStatus,data:e})}else a.isFunction(d)&&d({status:a.jd.e.sessionStatus.ERROR,
data:e})},function(b){a.isFunction(d)&&d({status:a.jd.e.sessionStatus.ERROR,data:b})}))},stopSession:function(b){a.jd.stopPolling();a.jd._ajax.token=void 0;a.jd._ajax.sessionStatus=a.jd.e.sessionStatus.NO_SESSION;a.jd.send("session/disconnect",b,b)},getSessionStatus:function(){return a.jd._ajax.sessionStatus},startPolling:function(){if(a.jd.isPollingContinuously())return this;a.jd._ajax.active=!0;a.jd._ajax.lastEventId=void 0;a.jd.pollOnce();return this},stopPolling:function(){a.jd._ajax.active=!1;
a.jd._ajax.jqXHR&&a.jd._ajax.jqXHR.abort&&a.jd._ajax.jqXHR.abort();a.jd._ajax.lastEventId=void 0;return this},isPollingContinuously:function(){return a.jd._ajax.active},pollOnce:function(){a.jd._ajax.sessionStatus===a.jd.e.sessionStatus.NO_SESSION?(a.jd.stopPolling(),a.jd._ajax.handlePoll({type:a.jd.e.messageType.SYSTEM,message:a.jd.e.sysMessage.ERROR,data:{status:"No active session. Did you call startSession()?"}})):(a.jd._ajax.jqXHR!==null&&a.jd._ajax.jqXHR.abort(),a.jd._ajax.jqXHR=a.ajax({dataType:a.jd._settings.sameDomain?
"json":"jsonp",type:"GET",url:a.jd._settings.apiServer+"events/listen",data:{token:a.jd._ajax.token,lastEventId:a.jd._ajax.lastEventId},async:!0,cache:!1,timeout:a.jd._settings.apiTimeout,success:a.jd._ajax.handlePoll,complete:a.jd._ajax.pollComplete,error:a.jd._ajax.pollError}));return this},send:function(b,c,d,e,f){a.isFunction(c)&&(f=e,e=d,d=c,c=void 0);a.isFunction(d)||(d=void 0);a.isFunction(f)||(f=void 0);a.isFunction(e)||(e=void 0);b[0]==="/"&&(b=b.substr(1));if(!a.isArray(c)&&c!==void 0)if(a.isPlainObject(c)){var g=
[];a.each(c,function(a,b){g.push(b)});c=g}else c=a.makeArray(c);a.jd._settings.debug&&console.log([a.jd._settings.apiServer+b,c,d,e,f]);a.ajax({dataType:a.jd._settings.sameDomain?"json":"jsonp",type:"GET",url:a.jd._settings.apiServer+b,data:{token:a.jd._ajax.token,p:c},async:!0,cache:!1,timeout:a.jd._settings.apiTimeout,success:function(b){a.jd._ajax.sendSuccess(b,d,e,f)},error:function(b,c,d){a.jd._ajax.sendError(b,c,d,e)}});return this},_settings:{user:void 0,pass:void 0,apiServer:"http://127.0.0.1:3128/",
onmessage:void 0,onerror:void 0,debug:!1,apiTimeout:15E3,sameDomain:!1},e:{sessionStatus:{NO_SESSION:void 0,ERROR:"error",ANONYMOUS:"anonymous",REGISTERED:"registered"},messageType:{SYSTEM:"system"},sysMessage:{ERROR:"error",DISCONNECT:"disconnect",HEARTBEAT:"heartbeat"}},_ajax:{lastEventId:void 0,active:!1,jqXHR:null,callbackMap:{},token:void 0,sessionStatus:void 0,sendSuccess:function(b,c,d,e){b.type&&b.type===a.jd.e.messageType.SYSTEM&&b.message&&b.message===a.jd.e.sysMessage.ERROR?d(b.data):(b.pid&&
a.isFunction(e)&&(a.jd._ajax.callbackMap[b.pid]=e,a.jd._settings.debug&&console.log(["Register PID...",b])),jQuery.isFunction(c)&&c(b.data,b.pid))},handlePoll:function(b){if(a.jd._ajax.lastEventId===void 0||a.jd._ajax.lastEventId===b.id-1||b.type&&b.type===a.jd.e.messageType.SYSTEM){if(b.data&&!(b.type&&b.type==a.jd.e.messageType.SYSTEM))a.jd._ajax.lastEventId=b.id+b.data.length-1;if(b.type&&b.type===a.jd.e.messageType.SYSTEM)switch(b.message){case a.jd.e.sysMessage.DISCONNECT:a.jd.stopPolling();
a.jd._ajax.token=void 0;break;case a.jd.e.sysMessage.HEARTBEAT:break;default:if(a.isFunction(a.jd._settings.onerror))a.jd._settings.onerror(b.data)}else a.jd._settings.debug&&console.log(b.data.length+" events in this message."),a.each(b.data,function(b,d){a.jd._ajax.handleEvent(d)})}},handleEvent:function(b){if(!(b.pid&&b.pid in a.jd._ajax.callbackMap&&a.jd._ajax.callbackMap[b.pid](b.data,b.pid)===!1)&&a.isFunction(a.jd._settings.onmessage))a.jd._settings.onmessage(b.data,b.pid)},pollComplete:function(){a.jd._ajax.jqXHR=
null;a.jd._ajax.active&&a.jd._ajax.active===!0&&(a.jd._settings.debug===!0?setTimeout(a.jd.pollOnce,1E3):a.jd.pollOnce())},pollError:function(b,c,d){a.jd._ajax.handlePoll({type:a.jd.e.messageType.SYSTEM,message:a.jd.e.sysMessage.ERROR,data:{jqXHR:b,status:c,errorThrown:d}})},sendError:function(b,c,d,e){a.isFunction(e)&&e({jqXHR:b,status:c,errorThrown:d})}}}})(jQuery);